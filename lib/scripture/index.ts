// @ts-nocheck
// Quran surah data with Arabic and English names
export const SURAHS = [
  { number: 1, arabic: 'Ø§Ù„ÙØ§ØªØ­Ø©', english: 'Al-Fatihah', verses: 7, type: 'meccan' },
  { number: 2, arabic: 'Ø§Ù„Ø¨Ù‚Ø±Ø©', english: 'Al-Baqarah', verses: 286, type: 'medinan' },
  { number: 3, arabic: 'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', english: 'Ali Imran', verses: 200, type: 'medinan' },
  { number: 4, arabic: 'Ø§Ù„Ù†Ø³Ø§Ø¡', english: 'An-Nisa', verses: 176, type: 'medinan' },
  { number: 5, arabic: 'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', english: 'Al-Maidah', verses: 120, type: 'medinan' },
  { number: 6, arabic: 'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', english: 'Al-Anam', verses: 165, type: 'meccan' },
  { number: 7, arabic: 'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', english: 'Al-Araf', verses: 206, type: 'meccan' },
  { number: 8, arabic: 'Ø§Ù„Ø£Ù†ÙØ§Ù„', english: 'Al-Anfal', verses: 75, type: 'medinan' },
  { number: 9, arabic: 'Ø§Ù„ØªÙˆØ¨Ø©', english: 'At-Tawbah', verses: 129, type: 'medinan' },
  { number: 10, arabic: 'ÙŠÙˆÙ†Ø³', english: 'Yunus', verses: 109, type: 'meccan' },
  { number: 11, arabic: 'Ù‡ÙˆØ¯', english: 'Hud', verses: 123, type: 'meccan' },
  { number: 12, arabic: 'ÙŠÙˆØ³Ù', english: 'Yusuf', verses: 111, type: 'meccan' },
  { number: 13, arabic: 'Ø§Ù„Ø±Ø¹Ø¯', english: 'Ar-Rad', verses: 43, type: 'meccan' },
  { number: 14, arabic: 'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…', english: 'Ibrahim', verses: 52, type: 'meccan' },
  { number: 15, arabic: 'Ø§Ù„Ø­Ø¬Ø±', english: 'Al-Hijr', verses: 99, type: 'meccan' },
  { number: 16, arabic: 'Ø§Ù„Ù†Ø­Ù„', english: 'An-Nahl', verses: 128, type: 'meccan' },
  { number: 17, arabic: 'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', english: 'Al-Isra', verses: 111, type: 'meccan' },
  { number: 18, arabic: 'Ø§Ù„ÙƒÙ‡Ù', english: 'Al-Kahf', verses: 110, type: 'meccan' },
  { number: 19, arabic: 'Ù…Ø±ÙŠÙ…', english: 'Maryam', verses: 98, type: 'meccan' },
  { number: 20, arabic: 'Ø·Ù‡', english: 'Ta-Ha', verses: 135, type: 'meccan' },
  { number: 21, arabic: 'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', english: 'Al-Anbiya', verses: 112, type: 'meccan' },
  { number: 22, arabic: 'Ø§Ù„Ø­Ø¬', english: 'Al-Hajj', verses: 78, type: 'medinan' },
  { number: 23, arabic: 'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', english: 'Al-Muminun', verses: 118, type: 'meccan' },
  { number: 24, arabic: 'Ø§Ù„Ù†ÙˆØ±', english: 'An-Nur', verses: 64, type: 'medinan' },
  { number: 25, arabic: 'Ø§Ù„ÙØ±Ù‚Ø§Ù†', english: 'Al-Furqan', verses: 77, type: 'meccan' },
  { number: 26, arabic: 'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', english: 'Ash-Shuara', verses: 227, type: 'meccan' },
  { number: 27, arabic: 'Ø§Ù„Ù†Ù…Ù„', english: 'An-Naml', verses: 93, type: 'meccan' },
  { number: 28, arabic: 'Ø§Ù„Ù‚ØµØµ', english: 'Al-Qasas', verses: 88, type: 'meccan' },
  { number: 29, arabic: 'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', english: 'Al-Ankabut', verses: 69, type: 'meccan' },
  { number: 30, arabic: 'Ø§Ù„Ø±ÙˆÙ…', english: 'Ar-Rum', verses: 60, type: 'meccan' },
  { number: 31, arabic: 'Ù„Ù‚Ù…Ø§Ù†', english: 'Luqman', verses: 34, type: 'meccan' },
  { number: 32, arabic: 'Ø§Ù„Ø³Ø¬Ø¯Ø©', english: 'As-Sajdah', verses: 30, type: 'meccan' },
  { number: 33, arabic: 'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', english: 'Al-Ahzab', verses: 73, type: 'medinan' },
  { number: 34, arabic: 'Ø³Ø¨Ø£', english: 'Saba', verses: 54, type: 'meccan' },
  { number: 35, arabic: 'ÙØ§Ø·Ø±', english: 'Fatir', verses: 45, type: 'meccan' },
  { number: 36, arabic: 'ÙŠØ³', english: 'Ya-Sin', verses: 83, type: 'meccan' },
  { number: 37, arabic: 'Ø§Ù„ØµØ§ÙØ§Øª', english: 'As-Saffat', verses: 182, type: 'meccan' },
  { number: 38, arabic: 'Øµ', english: 'Sad', verses: 88, type: 'meccan' },
  { number: 39, arabic: 'Ø§Ù„Ø²Ù…Ø±', english: 'Az-Zumar', verses: 75, type: 'meccan' },
  { number: 40, arabic: 'ØºØ§ÙØ±', english: 'Ghafir', verses: 85, type: 'meccan' },
  { number: 41, arabic: 'ÙØµÙ„Øª', english: 'Fussilat', verses: 54, type: 'meccan' },
  { number: 42, arabic: 'Ø§Ù„Ø´ÙˆØ±Ù‰', english: 'Ash-Shura', verses: 53, type: 'meccan' },
  { number: 43, arabic: 'Ø§Ù„Ø²Ø®Ø±Ù', english: 'Az-Zukhruf', verses: 89, type: 'meccan' },
  { number: 44, arabic: 'Ø§Ù„Ø¯Ø®Ø§Ù†', english: 'Ad-Dukhan', verses: 59, type: 'meccan' },
  { number: 45, arabic: 'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©', english: 'Al-Jathiyah', verses: 37, type: 'meccan' },
  { number: 46, arabic: 'Ø§Ù„Ø£Ø­Ù‚Ø§Ù', english: 'Al-Ahqaf', verses: 35, type: 'meccan' },
  { number: 47, arabic: 'Ù…Ø­Ù…Ø¯', english: 'Muhammad', verses: 38, type: 'medinan' },
  { number: 48, arabic: 'Ø§Ù„ÙØªØ­', english: 'Al-Fath', verses: 29, type: 'medinan' },
  { number: 49, arabic: 'Ø§Ù„Ø­Ø¬Ø±Ø§Øª', english: 'Al-Hujurat', verses: 18, type: 'medinan' },
  { number: 50, arabic: 'Ù‚', english: 'Qaf', verses: 45, type: 'meccan' },
  { number: 51, arabic: 'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª', english: 'Adh-Dhariyat', verses: 60, type: 'meccan' },
  { number: 52, arabic: 'Ø§Ù„Ø·ÙˆØ±', english: 'At-Tur', verses: 49, type: 'meccan' },
  { number: 53, arabic: 'Ø§Ù„Ù†Ø¬Ù…', english: 'An-Najm', verses: 62, type: 'meccan' },
  { number: 54, arabic: 'Ø§Ù„Ù‚Ù…Ø±', english: 'Al-Qamar', verses: 55, type: 'meccan' },
  { number: 55, arabic: 'Ø§Ù„Ø±Ø­Ù…Ù†', english: 'Ar-Rahman', verses: 78, type: 'meccan' },
  { number: 56, arabic: 'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©', english: 'Al-Waqiah', verses: 96, type: 'meccan' },
  { number: 57, arabic: 'Ø§Ù„Ø­Ø¯ÙŠØ¯', english: 'Al-Hadid', verses: 29, type: 'medinan' },
  { number: 58, arabic: 'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©', english: 'Al-Mujadila', verses: 22, type: 'medinan' },
  { number: 59, arabic: 'Ø§Ù„Ø­Ø´Ø±', english: 'Al-Hashr', verses: 24, type: 'medinan' },
  { number: 60, arabic: 'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©', english: 'Al-Mumtahanah', verses: 13, type: 'medinan' },
  { number: 61, arabic: 'Ø§Ù„ØµÙ', english: 'As-Saff', verses: 14, type: 'medinan' },
  { number: 62, arabic: 'Ø§Ù„Ø¬Ù…Ø¹Ø©', english: 'Al-Jumuah', verses: 11, type: 'medinan' },
  { number: 63, arabic: 'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†', english: 'Al-Munafiqun', verses: 11, type: 'medinan' },
  { number: 64, arabic: 'Ø§Ù„ØªØºØ§Ø¨Ù†', english: 'At-Taghabun', verses: 18, type: 'medinan' },
  { number: 65, arabic: 'Ø§Ù„Ø·Ù„Ø§Ù‚', english: 'At-Talaq', verses: 12, type: 'medinan' },
  { number: 66, arabic: 'Ø§Ù„ØªØ­Ø±ÙŠÙ…', english: 'At-Tahrim', verses: 12, type: 'medinan' },
  { number: 67, arabic: 'Ø§Ù„Ù…Ù„Ùƒ', english: 'Al-Mulk', verses: 30, type: 'meccan' },
  { number: 68, arabic: 'Ø§Ù„Ù‚Ù„Ù…', english: 'Al-Qalam', verses: 52, type: 'meccan' },
  { number: 69, arabic: 'Ø§Ù„Ø­Ø§Ù‚Ø©', english: 'Al-Haqqah', verses: 52, type: 'meccan' },
  { number: 70, arabic: 'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬', english: 'Al-Maarij', verses: 44, type: 'meccan' },
  { number: 71, arabic: 'Ù†ÙˆØ­', english: 'Nuh', verses: 28, type: 'meccan' },
  { number: 72, arabic: 'Ø§Ù„Ø¬Ù†', english: 'Al-Jinn', verses: 28, type: 'meccan' },
  { number: 73, arabic: 'Ø§Ù„Ù…Ø²Ù…Ù„', english: 'Al-Muzzammil', verses: 20, type: 'meccan' },
  { number: 74, arabic: 'Ø§Ù„Ù…Ø¯Ø«Ø±', english: 'Al-Muddaththir', verses: 56, type: 'meccan' },
  { number: 75, arabic: 'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©', english: 'Al-Qiyamah', verses: 40, type: 'meccan' },
  { number: 76, arabic: 'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', english: 'Al-Insan', verses: 31, type: 'medinan' },
  { number: 77, arabic: 'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª', english: 'Al-Mursalat', verses: 50, type: 'meccan' },
  { number: 78, arabic: 'Ø§Ù„Ù†Ø¨Ø£', english: 'An-Naba', verses: 40, type: 'meccan' },
  { number: 79, arabic: 'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª', english: 'An-Naziat', verses: 46, type: 'meccan' },
  { number: 80, arabic: 'Ø¹Ø¨Ø³', english: 'Abasa', verses: 42, type: 'meccan' },
  { number: 81, arabic: 'Ø§Ù„ØªÙƒÙˆÙŠØ±', english: 'At-Takwir', verses: 29, type: 'meccan' },
  { number: 82, arabic: 'Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±', english: 'Al-Infitar', verses: 19, type: 'meccan' },
  { number: 83, arabic: 'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†', english: 'Al-Mutaffifin', verses: 36, type: 'meccan' },
  { number: 84, arabic: 'Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚', english: 'Al-Inshiqaq', verses: 25, type: 'meccan' },
  { number: 85, arabic: 'Ø§Ù„Ø¨Ø±ÙˆØ¬', english: 'Al-Buruj', verses: 22, type: 'meccan' },
  { number: 86, arabic: 'Ø§Ù„Ø·Ø§Ø±Ù‚', english: 'At-Tariq', verses: 17, type: 'meccan' },
  { number: 87, arabic: 'Ø§Ù„Ø£Ø¹Ù„Ù‰', english: 'Al-Ala', verses: 19, type: 'meccan' },
  { number: 88, arabic: 'Ø§Ù„ØºØ§Ø´ÙŠØ©', english: 'Al-Ghashiyah', verses: 26, type: 'meccan' },
  { number: 89, arabic: 'Ø§Ù„ÙØ¬Ø±', english: 'Al-Fajr', verses: 30, type: 'meccan' },
  { number: 90, arabic: 'Ø§Ù„Ø¨Ù„Ø¯', english: 'Al-Balad', verses: 20, type: 'meccan' },
  { number: 91, arabic: 'Ø§Ù„Ø´Ù…Ø³', english: 'Ash-Shams', verses: 15, type: 'meccan' },
  { number: 92, arabic: 'Ø§Ù„Ù„ÙŠÙ„', english: 'Al-Layl', verses: 21, type: 'meccan' },
  { number: 93, arabic: 'Ø§Ù„Ø¶Ø­Ù‰', english: 'Ad-Duha', verses: 11, type: 'meccan' },
  { number: 94, arabic: 'Ø§Ù„Ø´Ø±Ø­', english: 'Ash-Sharh', verses: 8, type: 'meccan' },
  { number: 95, arabic: 'Ø§Ù„ØªÙŠÙ†', english: 'At-Tin', verses: 8, type: 'meccan' },
  { number: 96, arabic: 'Ø§Ù„Ø¹Ù„Ù‚', english: 'Al-Alaq', verses: 19, type: 'meccan' },
  { number: 97, arabic: 'Ø§Ù„Ù‚Ø¯Ø±', english: 'Al-Qadr', verses: 5, type: 'meccan' },
  { number: 98, arabic: 'Ø§Ù„Ø¨ÙŠÙ†Ø©', english: 'Al-Bayyinah', verses: 8, type: 'medinan' },
  { number: 99, arabic: 'Ø§Ù„Ø²Ù„Ø²Ù„Ø©', english: 'Az-Zalzalah', verses: 8, type: 'medinan' },
  { number: 100, arabic: 'Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª', english: 'Al-Adiyat', verses: 11, type: 'meccan' },
  { number: 101, arabic: 'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©', english: 'Al-Qariah', verses: 11, type: 'meccan' },
  { number: 102, arabic: 'Ø§Ù„ØªÙƒØ§Ø«Ø±', english: 'At-Takathur', verses: 8, type: 'meccan' },
  { number: 103, arabic: 'Ø§Ù„Ø¹ØµØ±', english: 'Al-Asr', verses: 3, type: 'meccan' },
  { number: 104, arabic: 'Ø§Ù„Ù‡Ù…Ø²Ø©', english: 'Al-Humazah', verses: 9, type: 'meccan' },
  { number: 105, arabic: 'Ø§Ù„ÙÙŠÙ„', english: 'Al-Fil', verses: 5, type: 'meccan' },
  { number: 106, arabic: 'Ù‚Ø±ÙŠØ´', english: 'Quraysh', verses: 4, type: 'meccan' },
  { number: 107, arabic: 'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†', english: 'Al-Maun', verses: 7, type: 'meccan' },
  { number: 108, arabic: 'Ø§Ù„ÙƒÙˆØ«Ø±', english: 'Al-Kawthar', verses: 3, type: 'meccan' },
  { number: 109, arabic: 'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†', english: 'Al-Kafirun', verses: 6, type: 'meccan' },
  { number: 110, arabic: 'Ø§Ù„Ù†ØµØ±', english: 'An-Nasr', verses: 3, type: 'medinan' },
  { number: 111, arabic: 'Ø§Ù„Ù…Ø³Ø¯', english: 'Al-Masad', verses: 5, type: 'meccan' },
  { number: 112, arabic: 'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ', english: 'Al-Ikhlas', verses: 4, type: 'meccan' },
  { number: 113, arabic: 'Ø§Ù„ÙÙ„Ù‚', english: 'Al-Falaq', verses: 5, type: 'meccan' },
  { number: 114, arabic: 'Ø§Ù„Ù†Ø§Ø³', english: 'An-Nas', verses: 6, type: 'meccan' }
];

// Common hadith collections
export const HADITH_COLLECTIONS = [
  'bukhari',
  'muslim',
  'abu-dawud',
  'tirmidhi',
  'ibn-majah',
  'nasai',
  'ahmad',
  'malik',
  'darimi'
];

export interface ScriptureReference {
  type: 'quran' | 'hadith';
  reference: string;
  normalized: string;
}

// Find surah by Arabic or English name
function findSurah(name: string): typeof SURAHS[0] | null {
  const normalized = name.trim().toLowerCase();

  return SURAHS.find(surah =>
    surah.arabic.includes(name) ||
    surah.english.toLowerCase().includes(normalized) ||
    surah.number.toString() === normalized
  ) || null;
}

// Normalize Quran reference
function normalizeQuranRef(match: string): { reference: string; normalized: string } {
  // Extract surah and verse information
  const surahMatch = match.match(/(\d+)|([a-zA-ZØ§-ÙŠ\s]+)/g);
  if (!surahMatch) return { reference: '', normalized: match };

  // Try to find surah number or name
  for (const part of surahMatch) {
    const surah = findSurah(part);
    if (surah) {
      // Extract verse numbers if present
      const verseMatch = match.match(/:(\d+(-\d+)?)/);
      if (verseMatch) {
        return {
          reference: `${surah.number}:${verseMatch[1]}`,
          normalized: `Quran ${surah.number}:${verseMatch[1]}`
        };
      } else {
        return {
          reference: '',
          normalized: `Quran ${surah.number}`
        };
      }
    }
  }

  return { reference: '', normalized: match };
}

// Normalize hadith reference
function normalizeHadithRef(match: string): { reference: string; normalized: string } {
  const lowerMatch = match.toLowerCase();

  for (const collection of HADITH_COLLECTIONS) {
    if (lowerMatch.includes(collection)) {
      // Extract hadith number if present
      const numberMatch = match.match(/(\d+)/);
      if (numberMatch) {
        return {
          reference: `${collection}:${numberMatch[1]}`,
          normalized: `Hadith:${collection}:${numberMatch[1]}`
        };
      } else {
        return {
          reference: '',
          normalized: `Hadith:${collection}:unknown`
        };
      }
    }
  }

  return { reference: '', normalized: match };
}

// Detect and normalize scripture references
export async function detectScriptureRefs(text: string): Promise<ScriptureReference[]> {
  const refs: ScriptureReference[] = [];

  // Pattern 1: Explicit bracketed references [[Quran 21:35]] or [[Hadith:Bukhari:authentic]]
  const explicitPattern = /\[\[([^\]]+)\]\]/g;
  let match;

  while ((match = explicitPattern.exec(text)) !== null) {
    const ref = match[1];
    if (ref.toLowerCase().includes('quran')) {
      const normalized = normalizeQuranRef(ref);
      refs.push({
        type: 'quran',
        reference: normalized.reference,
        normalized: normalized.normalized
      });
    } else if (ref.toLowerCase().includes('hadith')) {
      const normalized = normalizeHadithRef(ref);
      refs.push({
        type: 'hadith',
        reference: normalized.reference,
        normalized: normalized.normalized
      });
    }
  }

  // Pattern 2: Arabic scripture indicators
  const arabicQuranPattern = /(Ù‚Ø§Ù„ ØªØ¹Ø§Ù„Ù‰[^.ØŸ!Ø›]*[.ØŸ!Ø›])/g;
  while ((match = arabicQuranPattern.exec(text)) !== null) {
    refs.push({
      type: 'quran',
      reference: '',
      normalized: 'Quran:context'
    });
  }

  const arabicHadithPattern = /(Ù‚Ø§Ù„ Ø±Ø³ÙˆÙ„ Ø§Ù„Ù„Ù‡[^.ØŸ!Ø›]*[.ØŸ!Ø›])/g;
  while ((match = arabicHadithPattern.exec(text)) !== null) {
    refs.push({
      type: 'hadith',
      reference: '',
      normalized: 'Hadith:prophet:context'
    });
  }

  // Pattern 3: Verse-like content in parentheses or quotes
  const versePattern = /["'Â«Â»""][^"'Â«Â»""]*["'Â«Â»""]/g;
  while ((match = versePattern.exec(text)) !== null) {
    // Only consider as scripture if it contains Arabic and follows certain patterns
    const content = match[0];
    if (/[\u0600-\u06FF]/.test(content) && content.length > 10) {
      refs.push({
        type: 'quran',
        reference: '',
        normalized: 'Quran:verse'
      });
    }
  }

  // Filter out references with empty reference field where not appropriate
  return refs.filter(ref => ref.reference !== '' || ref.normalized.includes('context') || ref.normalized.includes('verse'));
}

// Get surah information by number
export function getSurahInfo(number: number): typeof SURAHS[0] | null {
  return SURAHS.find(surah => surah.number === number) || null;
}

// Validate verse range for a surah
export function isValidVerseRange(surahNumber: number, verse: number): boolean {
  const surah = getSurahInfo(surahNumber);
  return surah ? verse >= 1 && verse <= surah.verses : false;
}

// Format scripture banner for display
export function formatScriptureBanner(ref: string): string {
  if (ref.includes('Quran')) {
    return `ðŸ“– ${ref}`;
  } else if (ref.includes('Hadith')) {
    return `ðŸ“ ${ref}`;
  }
  return ref;
}

// Assistant-friendly helpers for Claude integration
export function formatScriptureForAssistant(
  reference: string,
  arabic?: string,
  english?: string,
  transliteration?: string
): string {
  const parts: string[] = [reference];

  if (arabic) {
    parts.push(`Arabic: ${arabic}`);
  }

  if (transliteration) {
    parts.push(`Transliteration: ${transliteration}`);
  }

  if (english) {
    parts.push(`English: "${english}"`);
  }

  return parts.join(' | ');
}

// Extract scripture references from text for assistant context
export function extractScriptureContext(text: string): Array<{
  reference: string;
  context: string;
  type: 'quran' | 'hadith';
}> {
  const results: Array<{
    reference: string;
    context: string;
    type: 'quran' | 'hadith';
  }> = [];

  // Look for Quranic references (x:y format)
  const quranPattern = /(\d{1,3}):(\d{1,3})/g;
  let match;

  while ((match = quranPattern.exec(text)) !== null) {
    const surahNum = parseInt(match[1]);
    const verseNum = parseInt(match[2]);

    if (isValidVerseRange(surahNum, verseNum)) {
      const surah = getSurahInfo(surahNum);
      results.push({
        reference: `${surahNum}:${verseNum}`,
        context: surah ? `Surah ${surah.english} (${surah.arabic})` : `Surah ${surahNum}`,
        type: 'quran'
      });
    }
  }

  // Look for hadith collection references
  const hadithPattern = /(bukhari|muslim|abu-dawud|tirmidhi|ibn-majah|nasai|ahmad|malik|darimi)[:\s]?(\d+)?/gi;

  while ((match = hadithPattern.exec(text)) !== null) {
    const collection = match[1].toLowerCase();
    const number = match[2] || 'unknown';

    results.push({
      reference: `${collection}:${number}`,
      context: `Hadith collection: ${collection}`,
      type: 'hadith'
    });
  }

  return results;
}

// Check if scripture references are preserved between original and revised text
export function validateScripturePreservation(
  originalText: string,
  revisedText: string
): {
  preserved: boolean;
  missing: string[];
  added: string[];
} {
  const originalRefs = extractScriptureContext(originalText);
  const revisedRefs = extractScriptureContext(revisedText);

  const originalRefSet = new Set(originalRefs.map(r => r.reference));
  const revisedRefSet = new Set(revisedRefs.map(r => r.reference));

  const missing = Array.from(originalRefSet).filter(ref => !revisedRefSet.has(ref));
  const added = Array.from(revisedRefSet).filter(ref => !originalRefSet.has(ref));

  return {
    preserved: missing.length === 0,
    missing,
    added
  };
}

// Generate friendly footnote text for Claude suggestions
export function generateScriptureFootnote(
  reference: string,
  type: 'quran' | 'hadith',
  brief: boolean = false
): string {
  if (type === 'quran') {
    const parts = reference.split(':');
    if (parts.length === 2) {
      const surahNum = parseInt(parts[0]);
      const verseNum = parts[1];
      const surah = getSurahInfo(surahNum);

      if (brief) {
        return `[^${reference}]: Quran ${reference}`;
      }

      return surah
        ? `[^${reference}]: Quran ${reference} - Surah ${surah.english} (${surah.arabic}), verse ${verseNum}`
        : `[^${reference}]: Quran ${reference}`;
    }
  }

  if (type === 'hadith') {
    const parts = reference.split(':');
    if (parts.length >= 2) {
      const collection = parts[0];
      const number = parts[1];

      if (brief) {
        return `[^${reference}]: Hadith ${collection} ${number}`;
      }

      return `[^${reference}]: Hadith from ${collection} collection, number ${number}`;
    }
  }

  return `[^${reference}]: ${reference}`;
}

// Find similar scripture references for context suggestions
export function findSimilarScripture(
  reference: string,
  type: 'quran' | 'hadith'
): string[] {
  if (type === 'quran') {
    const parts = reference.split(':');
    if (parts.length === 2) {
      const surahNum = parseInt(parts[0]);
      const verseNum = parseInt(parts[1]);
      const surah = getSurahInfo(surahNum);

      if (surah) {
        const suggestions: string[] = [];

        // Previous and next verses in same surah
        if (verseNum > 1) {
          suggestions.push(`${surahNum}:${verseNum - 1}`);
        }
        if (verseNum < surah.verses) {
          suggestions.push(`${surahNum}:${verseNum + 1}`);
        }

        return suggestions.slice(0, 3); // Limit to 3 suggestions
      }
    }
  }

  return [];
}

// Check if a scripture reference can be resolved with cached data only
export function isResolvableRef(reference: string, type: 'quran' | 'hadith'): boolean {
  if (type === 'quran') {
    const parts = reference.split(':');
    if (parts.length === 2) {
      const surahNum = parseInt(parts[0]);
      const verseNum = parseInt(parts[1]);
      return isValidVerseRange(surahNum, verseNum);
    }
  }

  if (type === 'hadith') {
    const parts = reference.split(':');
    if (parts.length >= 2) {
      const collection = parts[0].toLowerCase();
      return HADITH_COLLECTIONS.includes(collection);
    }
  }

  return false;
}