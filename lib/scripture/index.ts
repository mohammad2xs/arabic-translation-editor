// @ts-nocheck
// Quran surah data with Arabic and English names
export const SURAHS = [
  { number: 1, arabic: 'الفاتحة', english: 'Al-Fatihah', verses: 7, type: 'meccan' },
  { number: 2, arabic: 'البقرة', english: 'Al-Baqarah', verses: 286, type: 'medinan' },
  { number: 3, arabic: 'آل عمران', english: 'Ali Imran', verses: 200, type: 'medinan' },
  { number: 4, arabic: 'النساء', english: 'An-Nisa', verses: 176, type: 'medinan' },
  { number: 5, arabic: 'المائدة', english: 'Al-Maidah', verses: 120, type: 'medinan' },
  { number: 6, arabic: 'الأنعام', english: 'Al-Anam', verses: 165, type: 'meccan' },
  { number: 7, arabic: 'الأعراف', english: 'Al-Araf', verses: 206, type: 'meccan' },
  { number: 8, arabic: 'الأنفال', english: 'Al-Anfal', verses: 75, type: 'medinan' },
  { number: 9, arabic: 'التوبة', english: 'At-Tawbah', verses: 129, type: 'medinan' },
  { number: 10, arabic: 'يونس', english: 'Yunus', verses: 109, type: 'meccan' },
  { number: 11, arabic: 'هود', english: 'Hud', verses: 123, type: 'meccan' },
  { number: 12, arabic: 'يوسف', english: 'Yusuf', verses: 111, type: 'meccan' },
  { number: 13, arabic: 'الرعد', english: 'Ar-Rad', verses: 43, type: 'meccan' },
  { number: 14, arabic: 'إبراهيم', english: 'Ibrahim', verses: 52, type: 'meccan' },
  { number: 15, arabic: 'الحجر', english: 'Al-Hijr', verses: 99, type: 'meccan' },
  { number: 16, arabic: 'النحل', english: 'An-Nahl', verses: 128, type: 'meccan' },
  { number: 17, arabic: 'الإسراء', english: 'Al-Isra', verses: 111, type: 'meccan' },
  { number: 18, arabic: 'الكهف', english: 'Al-Kahf', verses: 110, type: 'meccan' },
  { number: 19, arabic: 'مريم', english: 'Maryam', verses: 98, type: 'meccan' },
  { number: 20, arabic: 'طه', english: 'Ta-Ha', verses: 135, type: 'meccan' },
  { number: 21, arabic: 'الأنبياء', english: 'Al-Anbiya', verses: 112, type: 'meccan' },
  { number: 22, arabic: 'الحج', english: 'Al-Hajj', verses: 78, type: 'medinan' },
  { number: 23, arabic: 'المؤمنون', english: 'Al-Muminun', verses: 118, type: 'meccan' },
  { number: 24, arabic: 'النور', english: 'An-Nur', verses: 64, type: 'medinan' },
  { number: 25, arabic: 'الفرقان', english: 'Al-Furqan', verses: 77, type: 'meccan' },
  { number: 26, arabic: 'الشعراء', english: 'Ash-Shuara', verses: 227, type: 'meccan' },
  { number: 27, arabic: 'النمل', english: 'An-Naml', verses: 93, type: 'meccan' },
  { number: 28, arabic: 'القصص', english: 'Al-Qasas', verses: 88, type: 'meccan' },
  { number: 29, arabic: 'العنكبوت', english: 'Al-Ankabut', verses: 69, type: 'meccan' },
  { number: 30, arabic: 'الروم', english: 'Ar-Rum', verses: 60, type: 'meccan' },
  { number: 31, arabic: 'لقمان', english: 'Luqman', verses: 34, type: 'meccan' },
  { number: 32, arabic: 'السجدة', english: 'As-Sajdah', verses: 30, type: 'meccan' },
  { number: 33, arabic: 'الأحزاب', english: 'Al-Ahzab', verses: 73, type: 'medinan' },
  { number: 34, arabic: 'سبأ', english: 'Saba', verses: 54, type: 'meccan' },
  { number: 35, arabic: 'فاطر', english: 'Fatir', verses: 45, type: 'meccan' },
  { number: 36, arabic: 'يس', english: 'Ya-Sin', verses: 83, type: 'meccan' },
  { number: 37, arabic: 'الصافات', english: 'As-Saffat', verses: 182, type: 'meccan' },
  { number: 38, arabic: 'ص', english: 'Sad', verses: 88, type: 'meccan' },
  { number: 39, arabic: 'الزمر', english: 'Az-Zumar', verses: 75, type: 'meccan' },
  { number: 40, arabic: 'غافر', english: 'Ghafir', verses: 85, type: 'meccan' },
  { number: 41, arabic: 'فصلت', english: 'Fussilat', verses: 54, type: 'meccan' },
  { number: 42, arabic: 'الشورى', english: 'Ash-Shura', verses: 53, type: 'meccan' },
  { number: 43, arabic: 'الزخرف', english: 'Az-Zukhruf', verses: 89, type: 'meccan' },
  { number: 44, arabic: 'الدخان', english: 'Ad-Dukhan', verses: 59, type: 'meccan' },
  { number: 45, arabic: 'الجاثية', english: 'Al-Jathiyah', verses: 37, type: 'meccan' },
  { number: 46, arabic: 'الأحقاف', english: 'Al-Ahqaf', verses: 35, type: 'meccan' },
  { number: 47, arabic: 'محمد', english: 'Muhammad', verses: 38, type: 'medinan' },
  { number: 48, arabic: 'الفتح', english: 'Al-Fath', verses: 29, type: 'medinan' },
  { number: 49, arabic: 'الحجرات', english: 'Al-Hujurat', verses: 18, type: 'medinan' },
  { number: 50, arabic: 'ق', english: 'Qaf', verses: 45, type: 'meccan' },
  { number: 51, arabic: 'الذاريات', english: 'Adh-Dhariyat', verses: 60, type: 'meccan' },
  { number: 52, arabic: 'الطور', english: 'At-Tur', verses: 49, type: 'meccan' },
  { number: 53, arabic: 'النجم', english: 'An-Najm', verses: 62, type: 'meccan' },
  { number: 54, arabic: 'القمر', english: 'Al-Qamar', verses: 55, type: 'meccan' },
  { number: 55, arabic: 'الرحمن', english: 'Ar-Rahman', verses: 78, type: 'meccan' },
  { number: 56, arabic: 'الواقعة', english: 'Al-Waqiah', verses: 96, type: 'meccan' },
  { number: 57, arabic: 'الحديد', english: 'Al-Hadid', verses: 29, type: 'medinan' },
  { number: 58, arabic: 'المجادلة', english: 'Al-Mujadila', verses: 22, type: 'medinan' },
  { number: 59, arabic: 'الحشر', english: 'Al-Hashr', verses: 24, type: 'medinan' },
  { number: 60, arabic: 'الممتحنة', english: 'Al-Mumtahanah', verses: 13, type: 'medinan' },
  { number: 61, arabic: 'الصف', english: 'As-Saff', verses: 14, type: 'medinan' },
  { number: 62, arabic: 'الجمعة', english: 'Al-Jumuah', verses: 11, type: 'medinan' },
  { number: 63, arabic: 'المنافقون', english: 'Al-Munafiqun', verses: 11, type: 'medinan' },
  { number: 64, arabic: 'التغابن', english: 'At-Taghabun', verses: 18, type: 'medinan' },
  { number: 65, arabic: 'الطلاق', english: 'At-Talaq', verses: 12, type: 'medinan' },
  { number: 66, arabic: 'التحريم', english: 'At-Tahrim', verses: 12, type: 'medinan' },
  { number: 67, arabic: 'الملك', english: 'Al-Mulk', verses: 30, type: 'meccan' },
  { number: 68, arabic: 'القلم', english: 'Al-Qalam', verses: 52, type: 'meccan' },
  { number: 69, arabic: 'الحاقة', english: 'Al-Haqqah', verses: 52, type: 'meccan' },
  { number: 70, arabic: 'المعارج', english: 'Al-Maarij', verses: 44, type: 'meccan' },
  { number: 71, arabic: 'نوح', english: 'Nuh', verses: 28, type: 'meccan' },
  { number: 72, arabic: 'الجن', english: 'Al-Jinn', verses: 28, type: 'meccan' },
  { number: 73, arabic: 'المزمل', english: 'Al-Muzzammil', verses: 20, type: 'meccan' },
  { number: 74, arabic: 'المدثر', english: 'Al-Muddaththir', verses: 56, type: 'meccan' },
  { number: 75, arabic: 'القيامة', english: 'Al-Qiyamah', verses: 40, type: 'meccan' },
  { number: 76, arabic: 'الإنسان', english: 'Al-Insan', verses: 31, type: 'medinan' },
  { number: 77, arabic: 'المرسلات', english: 'Al-Mursalat', verses: 50, type: 'meccan' },
  { number: 78, arabic: 'النبأ', english: 'An-Naba', verses: 40, type: 'meccan' },
  { number: 79, arabic: 'النازعات', english: 'An-Naziat', verses: 46, type: 'meccan' },
  { number: 80, arabic: 'عبس', english: 'Abasa', verses: 42, type: 'meccan' },
  { number: 81, arabic: 'التكوير', english: 'At-Takwir', verses: 29, type: 'meccan' },
  { number: 82, arabic: 'الانفطار', english: 'Al-Infitar', verses: 19, type: 'meccan' },
  { number: 83, arabic: 'المطففين', english: 'Al-Mutaffifin', verses: 36, type: 'meccan' },
  { number: 84, arabic: 'الانشقاق', english: 'Al-Inshiqaq', verses: 25, type: 'meccan' },
  { number: 85, arabic: 'البروج', english: 'Al-Buruj', verses: 22, type: 'meccan' },
  { number: 86, arabic: 'الطارق', english: 'At-Tariq', verses: 17, type: 'meccan' },
  { number: 87, arabic: 'الأعلى', english: 'Al-Ala', verses: 19, type: 'meccan' },
  { number: 88, arabic: 'الغاشية', english: 'Al-Ghashiyah', verses: 26, type: 'meccan' },
  { number: 89, arabic: 'الفجر', english: 'Al-Fajr', verses: 30, type: 'meccan' },
  { number: 90, arabic: 'البلد', english: 'Al-Balad', verses: 20, type: 'meccan' },
  { number: 91, arabic: 'الشمس', english: 'Ash-Shams', verses: 15, type: 'meccan' },
  { number: 92, arabic: 'الليل', english: 'Al-Layl', verses: 21, type: 'meccan' },
  { number: 93, arabic: 'الضحى', english: 'Ad-Duha', verses: 11, type: 'meccan' },
  { number: 94, arabic: 'الشرح', english: 'Ash-Sharh', verses: 8, type: 'meccan' },
  { number: 95, arabic: 'التين', english: 'At-Tin', verses: 8, type: 'meccan' },
  { number: 96, arabic: 'العلق', english: 'Al-Alaq', verses: 19, type: 'meccan' },
  { number: 97, arabic: 'القدر', english: 'Al-Qadr', verses: 5, type: 'meccan' },
  { number: 98, arabic: 'البينة', english: 'Al-Bayyinah', verses: 8, type: 'medinan' },
  { number: 99, arabic: 'الزلزلة', english: 'Az-Zalzalah', verses: 8, type: 'medinan' },
  { number: 100, arabic: 'العاديات', english: 'Al-Adiyat', verses: 11, type: 'meccan' },
  { number: 101, arabic: 'القارعة', english: 'Al-Qariah', verses: 11, type: 'meccan' },
  { number: 102, arabic: 'التكاثر', english: 'At-Takathur', verses: 8, type: 'meccan' },
  { number: 103, arabic: 'العصر', english: 'Al-Asr', verses: 3, type: 'meccan' },
  { number: 104, arabic: 'الهمزة', english: 'Al-Humazah', verses: 9, type: 'meccan' },
  { number: 105, arabic: 'الفيل', english: 'Al-Fil', verses: 5, type: 'meccan' },
  { number: 106, arabic: 'قريش', english: 'Quraysh', verses: 4, type: 'meccan' },
  { number: 107, arabic: 'الماعون', english: 'Al-Maun', verses: 7, type: 'meccan' },
  { number: 108, arabic: 'الكوثر', english: 'Al-Kawthar', verses: 3, type: 'meccan' },
  { number: 109, arabic: 'الكافرون', english: 'Al-Kafirun', verses: 6, type: 'meccan' },
  { number: 110, arabic: 'النصر', english: 'An-Nasr', verses: 3, type: 'medinan' },
  { number: 111, arabic: 'المسد', english: 'Al-Masad', verses: 5, type: 'meccan' },
  { number: 112, arabic: 'الإخلاص', english: 'Al-Ikhlas', verses: 4, type: 'meccan' },
  { number: 113, arabic: 'الفلق', english: 'Al-Falaq', verses: 5, type: 'meccan' },
  { number: 114, arabic: 'الناس', english: 'An-Nas', verses: 6, type: 'meccan' }
];

// Common hadith collections
export const HADITH_COLLECTIONS = [
  'bukhari',
  'muslim',
  'abu-dawud',
  'tirmidhi',
  'ibn-majah',
  'nasai',
  'ahmad',
  'malik',
  'darimi'
];

export interface ScriptureReference {
  type: 'quran' | 'hadith';
  reference: string;
  normalized: string;
}

// Find surah by Arabic or English name
function findSurah(name: string): typeof SURAHS[0] | null {
  const normalized = name.trim().toLowerCase();

  return SURAHS.find(surah =>
    surah.arabic.includes(name) ||
    surah.english.toLowerCase().includes(normalized) ||
    surah.number.toString() === normalized
  ) || null;
}

// Normalize Quran reference
function normalizeQuranRef(match: string): { reference: string; normalized: string } {
  // Extract surah and verse information
  const surahMatch = match.match(/(\d+)|([a-zA-Zا-ي\s]+)/g);
  if (!surahMatch) return { reference: '', normalized: match };

  // Try to find surah number or name
  for (const part of surahMatch) {
    const surah = findSurah(part);
    if (surah) {
      // Extract verse numbers if present
      const verseMatch = match.match(/:(\d+(-\d+)?)/);
      if (verseMatch) {
        return {
          reference: `${surah.number}:${verseMatch[1]}`,
          normalized: `Quran ${surah.number}:${verseMatch[1]}`
        };
      } else {
        return {
          reference: '',
          normalized: `Quran ${surah.number}`
        };
      }
    }
  }

  return { reference: '', normalized: match };
}

// Normalize hadith reference
function normalizeHadithRef(match: string): { reference: string; normalized: string } {
  const lowerMatch = match.toLowerCase();

  for (const collection of HADITH_COLLECTIONS) {
    if (lowerMatch.includes(collection)) {
      // Extract hadith number if present
      const numberMatch = match.match(/(\d+)/);
      if (numberMatch) {
        return {
          reference: `${collection}:${numberMatch[1]}`,
          normalized: `Hadith:${collection}:${numberMatch[1]}`
        };
      } else {
        return {
          reference: '',
          normalized: `Hadith:${collection}:unknown`
        };
      }
    }
  }

  return { reference: '', normalized: match };
}

// Detect and normalize scripture references
export async function detectScriptureRefs(text: string): Promise<ScriptureReference[]> {
  const refs: ScriptureReference[] = [];

  // Pattern 1: Explicit bracketed references [[Quran 21:35]] or [[Hadith:Bukhari:authentic]]
  const explicitPattern = /\[\[([^\]]+)\]\]/g;
  let match;

  while ((match = explicitPattern.exec(text)) !== null) {
    const ref = match[1];
    if (ref.toLowerCase().includes('quran')) {
      const normalized = normalizeQuranRef(ref);
      refs.push({
        type: 'quran',
        reference: normalized.reference,
        normalized: normalized.normalized
      });
    } else if (ref.toLowerCase().includes('hadith')) {
      const normalized = normalizeHadithRef(ref);
      refs.push({
        type: 'hadith',
        reference: normalized.reference,
        normalized: normalized.normalized
      });
    }
  }

  // Pattern 2: Arabic scripture indicators
  const arabicQuranPattern = /(قال تعالى[^.؟!؛]*[.؟!؛])/g;
  while ((match = arabicQuranPattern.exec(text)) !== null) {
    refs.push({
      type: 'quran',
      reference: '',
      normalized: 'Quran:context'
    });
  }

  const arabicHadithPattern = /(قال رسول الله[^.؟!؛]*[.؟!؛])/g;
  while ((match = arabicHadithPattern.exec(text)) !== null) {
    refs.push({
      type: 'hadith',
      reference: '',
      normalized: 'Hadith:prophet:context'
    });
  }

  // Pattern 3: Verse-like content in parentheses or quotes
  const versePattern = /["'«»""][^"'«»""]*["'«»""]/g;
  while ((match = versePattern.exec(text)) !== null) {
    // Only consider as scripture if it contains Arabic and follows certain patterns
    const content = match[0];
    if (/[\u0600-\u06FF]/.test(content) && content.length > 10) {
      refs.push({
        type: 'quran',
        reference: '',
        normalized: 'Quran:verse'
      });
    }
  }

  // Filter out references with empty reference field where not appropriate
  return refs.filter(ref => ref.reference !== '' || ref.normalized.includes('context') || ref.normalized.includes('verse'));
}

// Get surah information by number
export function getSurahInfo(number: number): typeof SURAHS[0] | null {
  return SURAHS.find(surah => surah.number === number) || null;
}

// Validate verse range for a surah
export function isValidVerseRange(surahNumber: number, verse: number): boolean {
  const surah = getSurahInfo(surahNumber);
  return surah ? verse >= 1 && verse <= surah.verses : false;
}

// Format scripture banner for display
export function formatScriptureBanner(ref: string): string {
  if (ref.includes('Quran')) {
    return `📖 ${ref}`;
  } else if (ref.includes('Hadith')) {
    return `📝 ${ref}`;
  }
  return ref;
}

// Assistant-friendly helpers for Claude integration
export function formatScriptureForAssistant(
  reference: string,
  arabic?: string,
  english?: string,
  transliteration?: string
): string {
  const parts: string[] = [reference];

  if (arabic) {
    parts.push(`Arabic: ${arabic}`);
  }

  if (transliteration) {
    parts.push(`Transliteration: ${transliteration}`);
  }

  if (english) {
    parts.push(`English: "${english}"`);
  }

  return parts.join(' | ');
}

// Extract scripture references from text for assistant context
export function extractScriptureContext(text: string): Array<{
  reference: string;
  context: string;
  type: 'quran' | 'hadith';
}> {
  const results: Array<{
    reference: string;
    context: string;
    type: 'quran' | 'hadith';
  }> = [];

  // Look for Quranic references (x:y format)
  const quranPattern = /(\d{1,3}):(\d{1,3})/g;
  let match;

  while ((match = quranPattern.exec(text)) !== null) {
    const surahNum = parseInt(match[1]);
    const verseNum = parseInt(match[2]);

    if (isValidVerseRange(surahNum, verseNum)) {
      const surah = getSurahInfo(surahNum);
      results.push({
        reference: `${surahNum}:${verseNum}`,
        context: surah ? `Surah ${surah.english} (${surah.arabic})` : `Surah ${surahNum}`,
        type: 'quran'
      });
    }
  }

  // Look for hadith collection references
  const hadithPattern = /(bukhari|muslim|abu-dawud|tirmidhi|ibn-majah|nasai|ahmad|malik|darimi)[:\s]?(\d+)?/gi;

  while ((match = hadithPattern.exec(text)) !== null) {
    const collection = match[1].toLowerCase();
    const number = match[2] || 'unknown';

    results.push({
      reference: `${collection}:${number}`,
      context: `Hadith collection: ${collection}`,
      type: 'hadith'
    });
  }

  return results;
}

// Check if scripture references are preserved between original and revised text
export function validateScripturePreservation(
  originalText: string,
  revisedText: string
): {
  preserved: boolean;
  missing: string[];
  added: string[];
} {
  const originalRefs = extractScriptureContext(originalText);
  const revisedRefs = extractScriptureContext(revisedText);

  const originalRefSet = new Set(originalRefs.map(r => r.reference));
  const revisedRefSet = new Set(revisedRefs.map(r => r.reference));

  const missing = Array.from(originalRefSet).filter(ref => !revisedRefSet.has(ref));
  const added = Array.from(revisedRefSet).filter(ref => !originalRefSet.has(ref));

  return {
    preserved: missing.length === 0,
    missing,
    added
  };
}

// Generate friendly footnote text for Claude suggestions
export function generateScriptureFootnote(
  reference: string,
  type: 'quran' | 'hadith',
  brief: boolean = false
): string {
  if (type === 'quran') {
    const parts = reference.split(':');
    if (parts.length === 2) {
      const surahNum = parseInt(parts[0]);
      const verseNum = parts[1];
      const surah = getSurahInfo(surahNum);

      if (brief) {
        return `[^${reference}]: Quran ${reference}`;
      }

      return surah
        ? `[^${reference}]: Quran ${reference} - Surah ${surah.english} (${surah.arabic}), verse ${verseNum}`
        : `[^${reference}]: Quran ${reference}`;
    }
  }

  if (type === 'hadith') {
    const parts = reference.split(':');
    if (parts.length >= 2) {
      const collection = parts[0];
      const number = parts[1];

      if (brief) {
        return `[^${reference}]: Hadith ${collection} ${number}`;
      }

      return `[^${reference}]: Hadith from ${collection} collection, number ${number}`;
    }
  }

  return `[^${reference}]: ${reference}`;
}

// Find similar scripture references for context suggestions
export function findSimilarScripture(
  reference: string,
  type: 'quran' | 'hadith'
): string[] {
  if (type === 'quran') {
    const parts = reference.split(':');
    if (parts.length === 2) {
      const surahNum = parseInt(parts[0]);
      const verseNum = parseInt(parts[1]);
      const surah = getSurahInfo(surahNum);

      if (surah) {
        const suggestions: string[] = [];

        // Previous and next verses in same surah
        if (verseNum > 1) {
          suggestions.push(`${surahNum}:${verseNum - 1}`);
        }
        if (verseNum < surah.verses) {
          suggestions.push(`${surahNum}:${verseNum + 1}`);
        }

        return suggestions.slice(0, 3); // Limit to 3 suggestions
      }
    }
  }

  return [];
}

// Check if a scripture reference can be resolved with cached data only
export function isResolvableRef(reference: string, type: 'quran' | 'hadith'): boolean {
  if (type === 'quran') {
    const parts = reference.split(':');
    if (parts.length === 2) {
      const surahNum = parseInt(parts[0]);
      const verseNum = parseInt(parts[1]);
      return isValidVerseRange(surahNum, verseNum);
    }
  }

  if (type === 'hadith') {
    const parts = reference.split(':');
    if (parts.length >= 2) {
      const collection = parts[0].toLowerCase();
      return HADITH_COLLECTIONS.includes(collection);
    }
  }

  return false;
}